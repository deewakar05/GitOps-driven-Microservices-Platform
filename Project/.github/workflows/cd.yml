name: CD - Build and Push to ECR

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: user-microservice
  DOCKER_IMAGE_NAME: user-microservice

jobs:
  build-and-push:
    name: Build and Push Docker Image to ECR
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ECR-Push

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: image-tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          echo "tag_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        working-directory: ./microservice
        run: |
          docker build -t ${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }} .
          docker tag ${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }} ${{ env.ECR_REPOSITORY }}:latest

      - name: Push Docker image to ECR
        run: |
          docker push ${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}
          docker push ${{ env.ECR_REPOSITORY }}:latest

      - name: Output image URI
        run: |
          echo "Image pushed to ECR:"
          echo "${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}"
          echo "${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest"

  build-local-test:
    name: Build Docker Image (Local Test)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref != 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        working-directory: ./microservice
        run: |
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} ${{ env.DOCKER_IMAGE_NAME }}:latest

      - name: Test Docker image
        working-directory: ./microservice
        run: |
          docker run -d -p 5000:5000 --name test-container ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          sleep 5
          curl -f http://localhost:5000/health || exit 1
          curl -f http://localhost:5000/api/users || exit 1
          docker stop test-container
          docker rm test-container

      - name: Save Docker image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-info
          path: |
            microservice/Dockerfile
          retention-days: 7
{
  "cells": [],
  "metadata": {
    "language_info": {
      "name": "python"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 2
}